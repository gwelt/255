<!doctype html>
<html>
<head>
  <meta name=viewport content="width=device-width, initial-scale=1">
  <title>255</title>
  <style>
    * {font:18px Helvetica, Arial; margin:0;padding:0;box-sizing:border-box;}
    body {}
    form {padding:3px;position:fixed;bottom:0;width:100%;}
    form input {border:0;padding:10px;width:100%;}
    #tweet {list-style-type:none;margin:0;padding:0;}
    #tweet li {padding:5px 10px;}
    #tweet li:nth-child(odd) {background:#eee;}
  </style>
</head>
<body>

  <ul id=tweet></ul><div style=height:50px></div>
  <form action=javascript:void(0); onsubmit=send_message(document.getElementById('message').value)><input id='message' autocomplete='off' type='text'></form>

  <script>
  var hostname_port=location.hostname+":3000";
  var ws=ws_open("ws://"+hostname_port);
  var reconnects=3;
  function ws_open(url) {
    ws=new WebSocket(url);
    ws.onmessage = function (message) {tweet('tweet',message.data)};
    ws.onerror = function(e) {console.log(e);tweet('tweet','CONNECTION ERROR ['+e.currentTarget.url+']')};
    ws.onclose = function(user) {console.log(user);tweet('tweet','CONNECTION CLOSED');ws=0;if (--reconnects>0) {
      tweet('tweet','TRYING TO RECONNECT...');setTimeout(function(){ws=ws_open("ws://"+hostname_port)},3000);
    }};
    setInterval(function(){ws.send('')},60000); // send empty message every minute to stay connected
    document.getElementById('message').focus();
    return ws;
  }
  function send_message(m) {
    if (m) {
      if (ws) {ws.send(m)} 
      else {var req = new XMLHttpRequest(); req.open('GET','http://'+hostname_port+'/m/'+m); req.send(); alert('Message delivered.')}
      document.getElementById('message').value=""; document.getElementById('message').focus();
    }
  }
  function tweet(ul_element,msg) {
    var node = document.createElement("LI");
    var textnode = document.createTextNode(msg);
    node.appendChild(textnode);
    document.getElementById(ul_element).appendChild(node);
    window.scrollTo(0,document.body.scrollHeight);
  }
  </script>

</body>
</html>
