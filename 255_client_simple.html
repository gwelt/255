<!doctype html>
<html>
	<head>
		<title>255</title>
	</head>
	<body>
		<div id=text></div>
		<script>
		var ws=ws_open(location.origin.replace(/^http/, 'ws'));
		var tweets=[];
		function send_message(m) {if (m) {if (ws) {ws.send(m)} else {var req = new XMLHttpRequest(); req.open('GET',window.location+'m/'+m); req.send();}}}
		function tweet(t) {
			if (t) {tweets.push(t)}
			while (tweets.length>8) {tweets.splice(0,1)}
			var etweet=document.getElementById('text');
			if (etweet) {
				etweet.innerHTML="";
				tweets.forEach(function(tt) {etweet.innerHTML+=tt+"<br>"});
				var form="<form action=javascript:void(0); onsubmit=send_message(document.getElementById('message').value)><input id='message' type='text'><input type=submit value='&gt;'></form>";
				etweet.innerHTML+=form;
				document.getElementById('message').focus();
			};
		}
		function ws_open(url) {
			ws=new WebSocket(url);
			ws.onmessage = function (message) {console.log(message);tweet(message.data)};
			ws.onerror = function(e) {console.log(e);tweet('CONNECTION ERROR ['+e.currentTarget.url+']')};
			ws.onclose = function(user) {console.log(user);tweet('CONNECTION CLOSED');ws=0;};
			return ws;
		}
		</script>
	</body>
</html>
